# Abstract
本研究提出了一种新颖的图像几何抽象范式，通过一组预定义的简单参数化基元（即三角形、矩形、圆形和半圆）进行组装，从而实现图像中形状的可控编辑。尽管该任务被表述为混合组合和连续优化问题，但在实际应用中，该任务被近似地重构为一种**令牌翻译神经框架**，该框架在图像到集合的转换过程中同时输出基元分配及相应的变换与颜色参数，从而绕过了复杂且不可微的图匹配迭代过程。

为减小搜索空间并解决梯度消失问题，本研究引入了一种新颖的**神经软分配**方案，通过透明度权重的多重光栅化组合巧妙地探索了二分图 b-匹配分配和不透明度加权组合的准等效性，从而显著降低了优化复杂度。在没有图像抽象标注（即矢量化表示）的情况下，基于可微光栅化技术的联结性，该框架能够在**自监督**的方式下实现端到端训练。大量实验表明，在多个数据集上，本框架能够仅通过**四种简单基元**组合生成极具吸引力的矢量化几何抽象结果，相比以往的图像抽象和矢量化方法，本框架还具备非常简洁的形状编辑能力，通过简单地替换基元类型即可实现。
# 1. Introduction
图像抽象，作为计算机视觉中的一个基本任务，最初旨在将给定的图像分解成一组基本的原始元素（例如，基本形状、曲线）以及它们之间的相互关系，目的是为了视觉理解或对象重建[6, 14, 13]。Haeberli等人[16]使用纹理映射作为绘画和抗锯齿文本绘制的原始元素；而Hu等人[19]采用统计学习策略，通过一组自然图像块来近似鬼成像（Ghost Imaging，简称GI[30]）。当代的抽象方法[24, 41, 20, 28]深入研究用参数化草图来表示图像。这些方法通常基于贝塞尔（Be ́zier）控制点来表示草图，输入图像被递归地转换成一系列贝塞尔曲线，基于深度架构如Transformers[34]或强化学习[28]。

除了草图，基于几何形状原始元素（如三角形、圆形等）的图像抽象方法[9, 39]可能更受频繁应用的欢迎，例如平面设计、工业设计、卡通制作、广告制作和现代艺术，基于以下事实：**1. 简单性和表达性**：一方面，几何原始元素具有非常紧凑和明确的参数格式，因此便于紧凑表示和方便操作。另一方面，几何原始元素的众多组合意味着与草图相比具有丰富的表达能力。例如，包豪斯和立体主义艺术倾向于仅采用简单的形状，如矩形和球体，但仍然具有极其丰富的艺术表现力。**2. 语义保留**：人类倾向于将复杂的视觉模式抽象成一些原始元素及其组合。例如，一个大圆圈、两个小圆圈和两个三角形就足以构成一个人脸。这两个主要原因使得现代标志设计和动画特别倾向于使用几何原始元素。本工作致力于几何原始元素的学习，以便重新组装和编辑艺术图像。

不幸的是，寻找（甚至近似）上述问题的最佳解决方案被认为是困难的，因为它本质上同时涉及组合（一种对多种原始类型选择的多对一匹配）和连续（对特定原始的最佳变换参数的推断）问题。必须解决以下挑战：

1. **高维性**：与仅需要预测控制点位置的基于草图的方法相比，几何抽象需要选择原语类型，导致组合空间呈指数级增长。此外，还需要同时预测更复杂的变换参数，如仿射系数和颜色，这进一步扩大了优化空间。
    
2. **非可微性**：请注意，原语选择的非可微性质与原语到像素的光栅化过程使得使用任何现成的深度学习框架的难度加倍。更严重的是，原语内部的封闭区域通常是平坦且无纹理的，因此流行的可微光栅化技术（例如Diffvg [23]）很难捕获向后传播的准确梯度信号，用于原语类型或变换参数校正，即所谓的梯度消失问题[18]。这个问题使得训练过程极不稳定，难以生成有意义的抽象结果。
    
3. **弱监督**：尽管在无/自监督表示学习方面取得了稳步进展，并在多个2D/3D视觉任务[17, 8, 47, 26, 25]上取得了令人鼓舞的结果，但现有的图像抽象方法[3, 28, 31]大多依赖于大量数据集（例如Quickdraw [15]）和精心设计的代价度量[41, 11]，其中矢量化草图标记可用于直接/强成对监督。然而，在这项工作中，我们只有光栅化图像用于训练，没有任何图像到矢量或图像到原语的标记，因此原语分配任务是在无监督（或自监督）设置中进行的，因为大规模高质量的参数化/矢量化格式的艺术图像极难收集。


为了追求几何抽象并解决上述困难，我们提出了一种新颖的图像几何抽象范式，该范式基于从预定义的简单参数化原始元素池（三角形、矩形、圆形和半圆形）中组装，便于在图像中进行可控的形状编辑。我们的框架具有以下设计特点：
在架构上，上述任务在令牌翻译神经框架（即变换器架构[40]）内被近似地重新构想，该框架同时输出原始分配和相应的变换参数以及颜色，以图像到集合的方式，从而绕过了复杂/不可微的原始分配迭代。为了避免穷举组合搜索，我们引入了一种新颖的神经软分配方案，该方案很好地探索了二分图b-匹配中的选择操作和透明度感知的加权多重光栅化组合之间的准等价性。也就是说，对于每个考虑的图像位置，首先融合多个原始选择（带有估计的变换），然后软性推断原始匹配权重作为不透明度值，以支持原始分配的可微学习。
此外，为了解决梯度消失的挑战，我们提出了一种质心过滤机制来校准封闭区域内的梯度，在该机制的核心是一个质心平滑核，为平坦原始创建了有效的梯度传播路径。在没有真实抽象图像标记（即矢量化表示）的情况下，整个流程可以通过基于可微光栅化技术的链接[23]以无监督的方式进行端到端训练。

我们在多个数据集上对提出的框架进行了广泛的实验，包括定性分析和定量分析，这些数据集包括表情符号[2]、图标[1]和包豪斯风格的平面设计。实验结果表明，我们的方法仅使用少量简单的几何形状原始原型就能生成极具吸引力的结果。与容易产生冗余和不匹配曲线的基于草图的方法相比，我们的方法实现了几个原始元素的紧凑组合，并具有良好的近似精度。此外，我们的方法可以通过在推理过程中简单地替换/编辑原始类型来生成具有丰富语义的新矢量化形状，这也表明了它在现代平面设计中的巨大应用潜力。

# 2. Related Works
## Image Abstraction
当代的图像抽象技术主要侧重于使用草图来表示图像，因为草图的简单性[36, 22, 31]。最近的努力[11, 41, 39]利用CLIP[32]模型来促进图像抽象，因为CLIP模型具有从草图和图像中提取语义概念的显著能力。例如，CLIPasso[41]使用预训练的CLIP模型提供几何和语义指导，并为输入图像生成具有多个抽象级别的草图。除了基于草图的图像抽象，几何抽象[9]是另一个有影响力的图像抽象范式。Tian等人[39]结合CLIP模型和进化策略[5]，通过优化参数化三角形的过程放置来抽象图像。然而，显然仅用三角形来有效地抽象具有不同结构的图像是不够的。此外，[39]中的结果仅限于完全语义（CLIP引导）或颜色均值误差（MSE引导）。在我们的工作中，我们探索了包含多种几何元素（如矩形和圆形等）的原始元素集合的几何抽象。我们的任务需要额外选择原始元素，这是不可微的，增加了优化的难度。

## Image Vectorization
我们的方法使用矢量图形原始元素来表示输入图像。在这个领域的先前工作[10, 44, 46]专注于预先分割图像，然后将分割的组件回归到矢量图形。在深度学习时代，研究人员使用可微渲染/光栅化[23]来进行图像矢量化。Im2Vec[33]提出了一个基于RNN的VAE模型，用于预测光栅图像的矢量路径，而无需矢量监督。LIVE[27]强调了路径初始化在图像矢量化任务中的重要性，提出了component-wise路径初始化，并以分层方式优化矢量图形。尽管LIVE取得了引人注目的矢量化结果，但由于其单次传递优化，效率较低。

我们的方法将图像矢量化表述为图像到集合的问题，并通过简单参数化原始元素的组合高效地合成高质量/规则的矢量图形。

## Reconstruction with primitives
我们的工作还与基于原始元素的重建相关，这在CAD设计[12, 35, 29, 48]和图像/草图压缩[3, 43, 45, 38]中常用。一个密切相关的工作是PMN[3]，它通过以监督的方式将草图与预定义的原始元素匹配来抽象草图，得益于大规模草图数据集。与上述方法不同，我们的工作提出了一个更加困难的任务：在没有矢量图形监督的情况下，用预定义的参数化原始元素重建光栅图像。

# 3. Methodology
## 3.1. Problem Definition
对于给定的光栅图像 I，我们的任务是使用参数化基元重新构建该图像。为此，我们首先定义了一个基元集合 $P = \{p_1, p_2, \dots, p_n\}$，包含 n 种几何形状类型，如三角形、矩形和圆形，其中每个基元由 t个点构成。为了采样和聚合这些基元来表示输入图像，我们训练模型将输入图像解码为一个变换集合 $T = \{T_1, \dots, T_m\}$，其中每个元素包括仿射变换系数，m 表示构建图像所需的参数形状数量。对于每个变换元素，我们选择其基元类型并使用相应的仿射参数对该基元进行变换。注意，不同的变换元素可以选择相同的基元类型。

因此，我们将该任务形式化为变换集合和基元集合之间的二部 b-匹配问题，其中 b=m。我们的任务是生成基元分配矩阵 $A = [a_{ij}]_{m \times n}$，其中 $a_{ij} \in \{0, 1\}$ 且 $a_{ij} = 1$ 表示存在分配 $(T_i, p_j)$。然后我们可以获得一组经过变换的形状 $S = \{s_i = T_i(p_j) | 1 \leq i \leq m, 1 \leq j \leq n, \forall a_{ij} = 1\}$，并将其光栅化以生成几何抽象结果。优化问题定义如下：

![image.png](https://raw.githubusercontent.com/Young-Allen/pic/main/20241105154635.png)

其中 R 表示光栅化函数，L 是用于评估像素误差的损失函数。

由于高维性、不可微性和弱监督的特点（如第 1 节所述），该任务难以使用常见的图匹配求解器（如匈牙利算法 [21] 或基于强化学习的方法 [42, 4]）进行优化。

为了方便阅读，我们统称“基元”来表示预定义的几何基元（即 P 中的元素），而“形状”则表示具有相应变换参数和颜色的变换基元实例（即 S 中的元素）。


## 3.2. Shape Attribute Set Prediction
![image.png](https://raw.githubusercontent.com/Young-Allen/pic/main/20241105182051.png)

为了从输入图像中采样一定数量的基元并将其转换为形状进行光栅化，我们训练模型预测形状属性集合，其中每个元素包括基元类型、变换参数和颜色。我们首先使用图像自编码器将输入图像嵌入为层次化特征/图像标记（包括包含丰富全局信息的高层特征 $H_t$​ 和表示局部细节的低层特征 $H_b$），并解码这些特征以重构输入图像，从而为形状属性集预测提供有效指导。

我们摒弃了笔画生成问题中的递归策略（即，下一笔画的参数生成依赖于前一笔画的输出和当前特征的输入），因为这种串行策略不仅需要迭代，还容易导致误差积累，尤其在中长距离空间布局和结构关系上无法显式探索。对于基于基元的图像分析和重构问题，关键在于通过空间上下文推断出哪个基元（及其变换和颜色参数）应填充某个图像位置/区域。

基于上述考虑，我们提出使用Transformer框架【40】来并行输出与基元匹配并构成整个输入图像的所有形状属性（如仿射系数和颜色）。换句话说，目标是采样一定数量的基元，并将其以合适的几何和外观属性放置在特定图像位置上。此方法的优势在于：一方面，通过位置编码机制将图像划分为有限的区域来指导局部最佳匹配（避免穷举的全局搜索）；另一方面，通过标记交互机制可以充分建模形状之间的全局依赖关系。

我们的形状属性集预测遵循经典的前馈集预测网络DETR【7】的架构。具体而言，图像编码器提取的图像特征与可学习位置编码连接后作为Transformer编码器的输入。接着，Transformer解码器将 m 个可学习查询作为输入，并将其转换为输出嵌入，即 $z \in R^{m \times d}$ 。输出嵌入随后通过三个预测头并行解码，即基元类型预测头、变换预测头和颜色预测头。

- **基元类型预测**：对于Sec. 3.1中定义的基元集合，每个变换（在 m 个之中）有 n 种可能的选择。因此，基元类型预测头通过softmax将嵌入映射为一个 n-维的概率分布，即 $F_w : z \to W \in R^{m \times n}$ ，从而将 A 放松为概率分布。

- **变换预测**：为了重构/近似各种复杂形状，我们定义了一个仿射变换矩阵 M，按旋转-缩放-平移-错切顺序对基元进行变换，包含旋转因子 $\alpha$ 、缩放因子 $(s_x, s_y)$ 、平移因子 $(t_x, t_y)$ 和错切因子$(\beta_x, \beta_y)$ 。因此，仿射变换预测可以定义为映射：$F_s : z \to \theta \in R^{m \times 7}$ 。为了使变换后的基元更精确地贴合形状，我们在仿射变换上引入点状偏移 $\Delta \in R^{m \times 2t}$ 作为细化，其中 t 为每个基元的参数点数。因此，每个变换 $T_i$​ 可以看作 $M (\theta_i)$ 和 $\Delta_i$ 的组合。

- **颜色预测**：同样地，我们将每个嵌入映射到颜色：$F_c : z \to C \in R^{m \times 3}$ 。

在推理过程中，我们直接选择具有最高概率的基元形状类型，并根据相应的变换和颜色进行光栅化。
## 3.3. Bipartite b-Matching with Neural Soft Assignment
![image.png](https://raw.githubusercontent.com/Young-Allen/pic/main/20241105194119.png)

我们将最优基元选择视作一个二部图的 b-匹配问题。通常可以使用匈牙利算法【21】进行迭代添加或移除匹配边【7, 37】。然而，匈牙利算法在我们的任务中并不适用，因为在此任务中，**没有矢量图形的监督信息**（即没有图元或矢量形式的图像作为监督标签），只有栅格图像（像素图）用于训练，因此无法对每个匹配项进行成对比较【37】。更严重的是，**逐像素损失评估需要单独的光栅化**：为了评估每个匹配候选图元的损失（即检查生成的图元和目标图像的匹配度），每个候选图元都需要进行单独的光栅化，将图元转换为像素图像以便与输入图像进行比较。这种逐像素的光栅化过程通常是计算密集的。**组合数导致计算量爆炸**：如果有一个包含 m 个变换的集合，以及一个包含 n 种形状类型的图元集合，那么为了覆盖所有匹配的可能性，光栅化的次数会达到 $n ^{m}$。这意味着对于每个可能的变换-形状组合都需要进行光栅化和损失计算。当 m 和 n 较大时，这种计算量是难以承受的。

我们观察到，在图像的每个位置上，先前的算法可能会选择某些低概率的基元，这些基元的光栅化像素模式与真实图像存在较大差异，因此这些低概率基元引入的梯度较不可靠。我们还注意到，在标准光栅化算法中，不同的图形基元/形状可以在同一位置上进行透明度叠加，即高透明度的形状对最终渲染模式的贡献较小。换言之，在可微光栅化方法中，透明度值用于描述元素/形状遮挡其背后内容的程度。

基于这一观察，我们提出了一种放松的二部图 b-匹配目标。核心思想是，将每个位置的所有可能基元的输出概率视作透明度值，这样所有候选项可以合并并叠加后进行一次光栅化。通过这种方式，我们显著减少了优化过程中对不同候选项的光栅化次数，并能更容易地将梯度反向传播至最接近真实形状的基元。

具体而言，令形状 $s_i$ 具有颜色 $c_i$ 和透明度 $o_i$，其对光栅化图像的贡献可视作 $o_i c_i$ ，且光栅化图像 $I_R$ 可表示为：

![image.png](https://raw.githubusercontent.com/Young-Allen/pic/main/20241105192658.png)

在图像位置 i 处，基元类型预测头预测的基元分配概率向量为 $w_i = [w_{i1}, w_{i2}, \dots, w_{in}]$ 。考虑到更高的分配权重将对光栅化模式产生更大影响，我们可以将分配权重定义为相应变换基元的不透明度的近似值，即 $w_{ij} \sim o_{ij}$ 。因此，最终的渲染模式是具有相同变换和颜色属性（即 $(T_i, c_i)$）的所有基元按透明度加权的组合：

![image.png](https://raw.githubusercontent.com/Young-Allen/pic/main/20241105192716.png)

由此，我们的优化目标变为：

![image.png](https://raw.githubusercontent.com/Young-Allen/pic/main/20241105192731.png)

上述公式通过在光栅化过程中仅柔性/连续地调整透明度值，而非在 nm-大小的搜索空间中搜索最优分配矩阵，从而显著简化了基元分配问题。此外，借助可微矢量图形光栅化技术【23】，可以将准确的梯度传播至最可能的基元。在图3中展示了我们提出的神经软分配与硬分配的对比示例。
## 3.4. Training Objectives

